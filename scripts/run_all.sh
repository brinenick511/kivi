#!/bin/bash

gpu_str=${1:-"0 1 2 3 4 9 "}

anno_list=(32_32_32_32_q_0 32_32_32_32_q_1 32_32_32_32_q_2 32_32_32_32_q_3 32_32_32_32_q_4 32_32_32_32_q_5 32_32_32_32_q_6 32_32_32_32_q_7 32_32_32_32_q_8 32_32_32_32_q_9 32_32_32_32_q_10 32_32_32_32_q_11 )
anno_list=(24_16_32_32_q_0 24_16_32_32_q_1 24_16_32_32_q_2 24_16_32_32_q_3 24_16_32_32_q_4 32_0_32_32_q_0 32_0_32_32_q_1 32_0_32_32_q_2 32_0_32_32_q_3 32_0_32_32_q_4 )
anno_list=(32_32_32_32_q_0 32_32_32_32_q_1 32_32_32_32_q_2 32_32_32_32_q_3 32_32_32_32_q_4 32_32_32_32_q_5 32_32_32_32_q_6 32_32_32_32_q_7 32_32_32_32_q_8 32_32_32_32_q_9 32_32_32_32_q_10 32_32_32_32_q_11 )
anno_list=(32_32_32_8_m_0 32_32_32_14_m_0 32_32_32_14_m_1 32_32_32_16_m_0 32_32_32_16_m_1 32_32_32_16_m_2 )
anno_list=(24_8_32_24_t_0 24_0_32_32_t_0 24_0_32_24_t_0 24_0_32_16_t_0 )
anno_list=(32_32_32_32_test_0_0 32_32_32_32_test_0_1 32_32_32_32_test_0_2 32_32_32_32_test_1_0 32_32_32_32_test_1_1 32_32_32_32_test_1_2 32_32_32_32_test_2_0 32_32_32_32_test_2_1 32_32_32_32_test_2_2 16_32_32_32_test_0_0 16_32_32_32_test_0_1 16_32_32_32_test_0_2 16_32_32_32_test_1_0 16_32_32_32_test_1_1 16_32_32_32_test_1_2 16_32_32_32_test_2_0 16_32_32_32_test_2_1 16_32_32_32_test_2_2 24_8_32_32_test_0_0 24_8_32_32_test_0_1 24_8_32_32_test_0_2 24_8_32_32_test_1_0 24_8_32_32_test_1_1 24_8_32_32_test_1_2 24_8_32_32_test_2_0 24_8_32_32_test_2_1 24_8_32_32_test_2_2 )
anno_list=(32_16_32_0_l_0_0 32_8_32_0_l_0_0 32_0_32_16_l_0_0 32_0_32_8_l_0_0 32_0_32_0_l_0_0 24_32_32_0_l_0_0 24_24_32_0_l_0_0 24_16_32_8_l_0_0 24_16_32_0_l_0_0 24_8_32_16_l_0_0 24_8_32_8_l_0_0 24_8_32_0_l_0_0 24_0_32_32_l_0_0 24_0_32_24_l_0_0 24_0_32_16_l_0_0 24_0_32_8_l_0_0 24_0_32_0_l_0_0 )
anno_list=(32_0_32_16_l_0_0 32_0_32_14_l_0_0 32_0_32_12_l_0_0 32_2_32_14_l_0_0 32_2_32_12_l_0_0 30_0_32_16_l_0_0 30_0_32_14_l_0_0 30_0_32_12_l_0_0 30_2_32_16_l_0_0 30_2_32_14_l_0_0 30_2_32_12_l_0_0 28_0_32_16_l_0_0 28_0_32_14_l_0_0 28_0_32_12_l_0_0 28_2_32_16_l_0_0 28_2_32_14_l_0_0 28_2_32_12_l_0_0 )
anno_list=(32_0_32_16_l_1_1 32_0_32_14_l_1_1 32_0_32_12_l_1_1 32_2_32_14_l_1_1 32_2_32_12_l_1_1 30_0_32_16_l_1_1 30_0_32_14_l_1_1 30_0_32_12_l_1_1 30_2_32_16_l_1_1 30_2_32_14_l_1_1 30_2_32_12_l_1_1 28_0_32_16_l_1_1 28_0_32_14_l_1_1 28_0_32_12_l_1_1 28_2_32_16_l_1_1 28_2_32_14_l_1_1 28_2_32_12_l_1_1 )
anno_list=(30_2_32_16_g_0_0 30_2_32_16_g_0_1 30_2_32_16_g_0_2 30_2_32_16_g_1_0 30_2_32_16_g_1_1 30_2_32_16_g_1_2 30_2_32_16_g_2_0 30_2_32_16_g_2_1 30_2_32_16_g_2_2 32_0_32_16_g_0_0 32_0_32_16_g_0_1 32_0_32_16_g_0_2 32_0_32_16_g_1_0 32_0_32_16_g_1_1 32_0_32_16_g_1_2 32_0_32_16_g_2_0 32_0_32_16_g_2_1 32_0_32_16_g_2_2 )

anno_list=(32_16_32_32_asym_0_0 32_32_32_32_kivi_0_0)

read -r -a gpus <<< "$gpu_str"

gpus=(5 6 )

num_gpus=${#gpus[@]}
num_annos=${#anno_list[@]}

gpu_tasks=()
for ((i = 0; i < num_gpus; i++)); do
    gpu_tasks[i]=0
done

for ((i = 0; i < num_annos; i++)); do
    gpu_index=$((i % num_gpus))
    gpu_tasks[gpu_index]=$((gpu_tasks[gpu_index] + 1))
done

cleanup() {
    echo "收到终止信号，正在停止所有子进程..."
    pkill -P $$  # 终止当前脚本派生的所有子进程
    wait
    echo "所有子进程已停止"
    exit 1
}

trap cleanup SIGINT

start=0
for ((i = 0; i < num_gpus; i++)); do
    gpu=${gpus[$i]}
    tasks_count=${gpu_tasks[i]}
    end=$((start + tasks_count))
    sub_list=("${anno_list[@]:$start:$tasks_count}")
    start=$end

    sub_list_str=$(IFS=","; echo "${sub_list[*]}")
    
    if [ $tasks_count -gt 0 ]; then
        echo "分配任务给 GPU $gpu: ${sub_list[*]}"
        bash ${HOME}/kivi/scripts/run_list_distributed.sh $gpu "$sub_list_str" &
    else
        echo "GPU $gpu 没有分配任务"
    fi
done

wait
echo "Done!"
